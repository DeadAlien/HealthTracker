<!DOCTYPE html>
<html>
<head>
    <title>Register</title>
    <head>
        <title>Register</title>
    </head>
    <form method="post" id="regForm" onsubmit="return validateRegForm(event)">
        Email: <input name="email" id="email" type="email" required pattern="^[\w\.-]+@[\w\.-]+\.\w+$"><br>
        Password: <input name="password" id="password" type="password" required minlength="6"><br>
        Mobile: <input name="mobile"><br>
        Age: <input name="age" id="age" type="number" min="1" required><br>
        Gender: <select name="gender" id="gender" required>
            <option value="">Select</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
            <option value="Other">Other</option>
        </select><br>
        Height (cm): <input name="height" id="height" type="number" min="1" required><br>
        Weight (kg): <input name="weight" id="weight" type="number" min="1" required><br>
        Goal Weight (kg): <input name="goal_weight" id="goal_weight" type="number" min="1" required><br>
        Activity Level:
        <select name="activity" id="activity" required>
            <option value="Sedentary">ğŸ›‹ï¸ Sedentary (Little or no exercise)</option>
            <option value="Lightly Active">ğŸš¶ Lightly Active (Light exercise 1â€“3 days/week)</option>
            <option value="Moderately Active">ğŸƒ Moderately Active (Moderate exercise 3â€“5 days/week)</option>
            <option value="Very Active">ğŸ‹ï¸ Very Active (Hard exercise 6â€“7 days/week)</option>
            <option value="Super Active">ğŸ”¥ Super Active (Intense training or physical job)</option>
        </select><br>
        Diet Preference:
        <select name="diet" id="diet" required>
            <option value="High Protein">ğŸ— High Protein</option>
            <option value="Vegetarian">ğŸ¥— Vegetarian</option>
            <option value="Vegan">ğŸ¥‘ Vegan</option>
            <option value="Balanced/Mixed">ğŸš Balanced/Mixed</option>
            <option value="Low Carb / Keto">ğŸ¥© Low Carb / Keto</option>
            <option value="High Carb">ğŸ High Carb</option>
            <option value="Paleo">ğŸ± Paleo</option>
            <option value="Gluten-Free">ğŸ¥› Gluten-Free</option>
            <option value="No preference">ğŸš« No preference</option>
        </select><br>
        Fitness Goals (Choose one or more):<br>
        <select name="fitness_goals" id="fitness_goals" multiple size="5" required>
            <option value="Fat Loss">ğŸ”¥ Fat Loss</option>
            <option value="Muscle Gain">ğŸ’ª Muscle Gain</option>
            <option value="Weight Maintenance">âš–ï¸ Weight Maintenance</option>
            <option value="Flexibility & Mobility">ğŸ§˜ Flexibility & Mobility</option>
            <option value="Cardiovascular Health">â¤ï¸ Cardiovascular Health</option>
            <option value="Mental Well-being">ğŸ§  Mental Well-being</option>
            <option value="Strength & Performance">ğŸ‹ï¸ Strength & Performance</option>
            <option value="Endurance / Stamina">ğŸƒ Endurance / Stamina</option>
            <option value="Medical Rehabilitation">ğŸ©º Medical Rehabilitation</option>
        </select><br>
    <span id="regError" style="color:red;"></span><br>
    <button type="submit">Register</button>
    </form>
    <!-- Pop-up messages handled by JS above -->
    <script>
    async function validateRegForm(event) {
        let email = document.getElementById('email').value;
        let password = document.getElementById('password').value;
        let age = document.getElementById('age').value;
        let height = document.getElementById('height').value;
        let weight = document.getElementById('weight').value;
        let goal_weight = document.getElementById('goal_weight').value;
        let gender = document.getElementById('gender').value;
        let activity = document.getElementById('activity').value;
        let diet = document.getElementById('diet').value;
        let mobile = document.getElementsByName('mobile')[0].value;
        let fitness_goals = document.getElementById('fitness_goals').selectedOptions;
        let error = '';
        if (!email.match(/^[\w\.-]+@[\w\.-]+\.\w+$/)) error = 'Invalid email.';
        else if (password.length < 6) error = 'Password must be at least 6 characters.';
        else if (age <= 0 || height <= 0 || weight <= 0 || goal_weight <= 0) error = 'Numbers must be positive.';
        else if (!gender) error = 'Select gender.';
        else if (!activity) error = 'Select activity.';
        else if (!diet) error = 'Select diet.';
        else if (fitness_goals.length === 0) error = 'Select at least one fitness goal.';
        if (!error) {
            // AJAX check for email/mobile uniqueness
            let resp = await fetch('/check-unique?email=' + encodeURIComponent(email) + '&mobile=' + encodeURIComponent(mobile));
            let data = await resp.json();
            if (!data.email_unique) error = 'Email already registered.';
            else if (!data.mobile_unique) error = 'Mobile number already registered.';
        }
        if (error) {
            document.getElementById('regError').innerText = error;
            alert(error); // Show pop-up for frontend validation errors
            event.preventDefault();
            return false;
        }
        return true;
    }
    </script>
    <a href="/login">Already have an account? Login</a>
</body>
<script>
// Show pop-up if backend flashes a message
window.onload = function() {
    var msg = [];
    try {
        msg = {{ get_flashed_messages()|tojson|safe }};
    } catch (e) {}
    if (msg && msg.length > 0) {
        // If registration was successful, show success pop-up and redirect to login
        if (msg[0].toLowerCase().includes('success')) {
            alert(msg[0]);
            window.location.href = '/login';
        } else {
            alert(msg[0]);
        }
    }
}
</script>
</body>
</html>
